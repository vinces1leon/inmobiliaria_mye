{% extends 'cotizaciones/base.html' %}
{% load custom_filters %}
{% block title %}Lista de Departamentos{% endblock %}

{% block content %}
<style>
    .main-container {
        display: flex;
        gap: 30px;
        margin-top: 20px;
    }
    
    .building-section {
        flex: 0 0 65%;
    }
    
    .details-section {
        flex: 0 0 35%;
        position: sticky;
        top: 20px;
        height: fit-content;
    }
    
    .building-container {
        display: flex;
        align-items: flex-start;
        gap: 15px;
    }
    
    .floor-labels {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .floor-label {
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 10px;
        font-weight: 600;
        font-size: 13px;
        color: #495057;
        margin-bottom: 0.2px;
    }
    
    .apartments-grid {
        flex: 1;
    }
    
    .floor-row {
        display: flex;
        gap: 2px;
        margin-bottom: 2px;
    }
    
    .apartment-cell {
        flex: 1;
        height: 45px;
        border: 2px solid #333;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        text-transform: uppercase;
    }
    
    .apartment-cell:hover:not(.azotea-cell) {
        transform: scale(1.08);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10;
        border-color: #0d6efd;
    }
    
    .apartment-cell.active {
        border: 3px solid #0d6efd;
        box-shadow: 0 0 0 3px rgba(13,110,253,0.25);
    }
    
    .apartment-cell.vendido {
        background-color: #ffeb3b;
        color: #000;
    }
    
    .apartment-cell.separado {
        background-color: #ff9800;
        color: #000;
    }
    
    .apartment-cell.disponible {
        background-color: #fff;
        color: #000;
    }
    
    .apartment-cell.empty {
        background-color: #e9ecef;
        border-color: #adb5bd;
        color: #6c757d;
        border-style: dashed;
        position: relative;
    }
    
    .apartment-cell.empty:hover {
        background-color: #d3d9df;
        border-color: #0d6efd;
        border-style: dashed;
    }
    
    .apartment-cell.empty::after {
        content: '+';
        font-size: 20px;
        color: #6c757d;
        position: absolute;
        opacity: 0.5;
    }
    
    .apartment-cell.empty:hover::after {
        opacity: 1;
        color: #0d6efd;
    }
    
    .apartment-cell.azotea-cell {
        cursor: default;
    }
    
    .apartment-cell.azotea-cell:hover {
        transform: none;
        box-shadow: none;
    }
    
    .legend {
        display: flex;
        gap: 25px;
        margin: 20px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
    }
    
    .legend-color {
        width: 35px;
        height: 25px;
        border: 2px solid #333;
    }
    
    .legend-color.vendido {
        background-color: #ffeb3b;
    }
    
    .legend-color.separado {
        background-color: #ff9800;
    }
    
    .legend-color.disponible {
        background-color: #fff;
    }
    
    .details-panel {
        background: #fff;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .details-panel.empty {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        color: #6c757d;
        font-style: italic;
        text-align: center;
    }
    
    .details-header {
        border-bottom: 3px solid #0d6efd;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    
    .details-header h4 {
        margin: 0;
        color: #0d6efd;
        font-weight: 700;
    }
    
    .details-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .detail-row:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }
    
    .detail-value {
        color: #212529;
        font-weight: 500;
        font-size: 14px;
    }
    
    .detail-value.price {
        font-size: 18px;
        color: #0d6efd;
        font-weight: 700;
    }
    
    .details-actions {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 2px solid #e9ecef;
    }
    
    .badge-status {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
    }

    .apartment-cell.bloqueado {
        cursor: not-allowed;
        opacity: 0.6;
        position: relative;
    }

    .apartment-cell.bloqueado:hover {
        transform: none;
        box-shadow: none;
        border-color: #333;
    }

    .apartment-cell.bloqueado::before {
        content: 'üîí';
        position: absolute;
        top: 2px;
        right: 4px;
        font-size: 10px;
        opacity: 0.7;
    }

    .price-blur {
        filter: blur(6px);
        cursor: pointer;
        transition: filter 0.2s ease;
    }

    .price-visible {
        filter: blur(0);
        cursor: pointer;
    }
</style>

<h2 class="mb-4">Departamentos Disponibles</h2>

<!-- Leyenda -->
<div class="legend">
    <div class="legend-item">
        <div class="legend-color vendido"></div>
        <span>Vendido</span>
    </div>
    <div class="legend-item">
        <div class="legend-color separado"></div>
        <span>Separado</span>
    </div>
    <div class="legend-item">
        <div class="legend-color disponible"></div>
        <span>Disponible</span>
    </div>
</div>

<div class="main-container">
    <!-- Secci√≥n del edificio -->
    <div class="building-section">
        <div class="building-container">
            <div class="floor-labels">
                <div class="floor-label">Azotea</div>
                {% for piso in pisos_range reversed %}
                    <div class="floor-label">Piso {{ piso }}</div>
                {% endfor %}
            </div>
            
            <div class="apartments-grid">
                <!-- Azotea - Solo √Åreas Sociales -->
                <div class="floor-row">
                    <div class="apartment-cell disponible azotea-cell" style="width: 100%;">√ÅREAS SOCIALES</div>
                </div>
                
                <!-- Pisos 18 a 1 (descendente) -->
                {% for piso in pisos_range reversed %}
                <div class="floor-row" data-piso="{{ piso }}">
                    {% with depts_en_piso=departamentos_por_piso|get_item:piso %}
                        {% if depts_en_piso %}
                        <!-- Mostrar los departamentos que existen -->
                            {% for dept in depts_en_piso %}
                                {% if dept.obj.estado == 'vendido' and not es_admin %}
                                <!-- Departamento vendido y usuario NO es admin - BLOQUEADO -->
                                    <div class="apartment-cell vendido bloqueado"
                                        title="Departamento vendido - Solo administradores pueden ver detalles">
                                        {{ dept.obj.codigo|upper }}
                                    </div>
                                {% else %}
                                    <!-- Departamento disponible o usuario ES admin - NORMAL -->
                                    <div class="apartment-cell {{ dept.obj.estado }}"
                                        data-id="{{ dept.obj.id }}"
                                        data-codigo="{{ dept.obj.codigo }}"
                                        data-nombre="{{ dept.obj.nombre }}"
                                        data-area="{{ dept.obj.area_m2 }}"
                                        data-area-libre="{{ dept.obj.area_libre }}"
                                        data-precio="{{ dept.precio_mostrado }}"
                                        data-habitaciones="{{ dept.obj.habitaciones }}"
                                        data-banos="{{ dept.obj.banos }}"
                                        data-piso="{{ dept.obj.pisos }}"
                                        data-estado="{{ dept.obj.estado }}"
                                        data-imagen="{% if dept.obj.imagen %}{{ dept.obj.imagen.url }}{% endif %}"
                                        data-editar-url="{% url 'cotizaciones:editar_departamento' dept.obj.id %}"
                                        onclick="showApartmentDetails(this, event)">
                                        {{ dept.obj.codigo|upper }}
                                    </div>
                                {% endif %}
                            {% endfor %}
            
                            <!-- Rellenar espacios vac√≠os si hay menos de 2 departamentos -->
                            {% if depts_en_piso|length == 1 %}
                                <div class="apartment-cell empty" 
                                    data-piso="{{ piso }}"
                                    data-posicion="2"
                                    onclick="createNewApartment({{ piso }}, 2)">
                                    -
                                </div>
                            {% endif %}
                        {% else %}
                            <!-- No hay departamentos en este piso, mostrar 2 espacios vac√≠os -->
                            <div class="apartment-cell empty" 
                                data-piso="{{ piso }}"
                                data-posicion="1"
                                onclick="createNewApartment({{ piso }}, 1)">
                                -
                            </div>
                            <div class="apartment-cell empty" 
                                data-piso="{{ piso }}"
                                data-posicion="2"
                                onclick="createNewApartment({{ piso }}, 2)">
                                -
                            </div>
                        {% endif %}
                    {% endwith %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Panel de detalles -->
    <div class="details-section">
        <div class="details-panel empty" id="detailsPanel">
            <p>Selecciona un departamento para ver sus detalles<br><br>
            <small>Haz click en las casillas vac√≠as (<strong>-</strong>) para agregar un nuevo departamento</small></p>
        </div>
    </div>
</div>

<script>
function showApartmentDetails(element, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    document.querySelectorAll('.apartment-cell').forEach(cell => {
        cell.classList.remove('active');
    });
    
    element.classList.add('active');
    
    const data = element.dataset;
    const estado = data.estado;
    
    let estadoBadge = '';
    if (estado === 'disponible') {
        estadoBadge = '<span class="badge bg-success badge-status">Disponible</span>';
    } else if (estado === 'vendido') {
        estadoBadge = '<span class="badge bg-warning text-dark badge-status">Vendido</span>';
    } else if (estado === 'separado') {
        estadoBadge = '<span class="badge bg-danger badge-status">Separado</span>';
    }
    
    let imageHtml = '';
    if (data.imagen) {
        imageHtml = `<img src="${data.imagen}" alt="${data.nombre}" class="details-image">`;
    }
    
    const cotizacionUrl = `/cotizaciones/nueva/?departamento=${data.id}`;

    /* -----------------------------------------
       üî• AGREGAR BOT√ìN EDITAR (SOLO SI ADMIN)
    ------------------------------------------ */
    {% if es_admin %}
        const editarHtml = `
            <a href="${data.editarUrl}" class="btn btn-primary w-100">
                <i class="bi bi-pencil-square"></i> Editar Departamento
            </a>
        `;
    {% else %}
        const editarHtml = ``;
    {% endif %}
    /* ----------------------------------------- */

    const detailsHtml = `
        <div class="details-header">
            <h4>DEPARTAMENTO ${data.codigo.toUpperCase()}</h4>
        </div>
        
        ${imageHtml}
        
        <div class="details-content">
            <div class="detail-row">
                <span class="detail-label">Nombre:</span>
                <span class="detail-value">${data.nombre}</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">Piso:</span>
                <span class="detail-value">Piso ${data.piso}</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">√Årea Total:</span>
                <span class="detail-value">${data.area} m¬≤</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">√Årea Libre:</span>
                <span class="detail-value">${data.areaLibre} m¬≤</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">Habitaciones:</span>
                <span class="detail-value">${data.habitaciones}</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">Ba√±os:</span>
                <span class="detail-value">${data.banos}</span>
            </div>
            
            <div class="detail-row price-blur" onclick="toggleBlur(this)">
                <span class="detail-label">Precio:</span>
                <span class="detail-value price">
                    S/ ${parseFloat(data.precio).toLocaleString('es-PE', {minimumFractionDigits: 2})}
                </span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">Estado:</span>
                <span class="detail-value">${estadoBadge}</span>
            </div>
        </div>
        
        <div class="details-actions">
            <a href="${cotizacionUrl}" class="btn btn-success w-100 mb-2">
                <i class="bi bi-file-earmark-text"></i> Nueva Cotizaci√≥n
            </a>

            ${editarHtml}
        </div>
    `;
    
    const panel = document.getElementById('detailsPanel');
    panel.classList.remove('empty');
    panel.innerHTML = detailsHtml;
}


function createNewApartment(piso, posicion) {
    const url = "{% url 'cotizaciones:nuevo_departamento' %}?piso=" + piso + "&posicion=" + posicion;
    window.location.href = url;
}

function toggleBlur(element) {
    if (element.classList.contains('price-blur')) {
        element.classList.remove('price-blur');
        element.classList.add('price-visible');
    } else {
        element.classList.remove('price-visible');
        element.classList.add('price-blur');
    }
}
</script>

{% endblock %}